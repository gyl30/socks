name: CI

on:
  push:
    branches: [ "main" ]

env:
  BOOST_VERSION: "1.89.0"
  BOOST_ARCHIVE: "boost_1_89_0.tar.bz2"
  BOOST_SRC_DIR: "boost_1_89_0"
  BOOST_INSTALL_PREFIX: "/home/runner/.local/boost-1.89"

jobs:
  guard-expected-assertion-style:
    name: Guard Expected Assertion Style
    runs-on: ubuntu-22.04

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Guard Expected Assertion Style
      run: |
        set -euo pipefail
        if grep -R -n -E 'value_or[[:space:]]*\(' tests --include='*_test.cpp'; then
          echo "Found forbidden expected assertion pattern in tests: value_or(...)"
          exit 1
        fi

  complexity-gate:
    name: Complexity Gate
    runs-on: ubuntu-22.04

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Install System Dependencies
      run: |
        set -euo pipefail
        sudo apt-get update
        sudo apt-get install -y python3 python3-pip

    - name: Install Lizard
      run: |
        set -euo pipefail
        python3 -m pip install lizard

    - name: Enforce Changed Function Complexity Threshold
      run: |
        set -euo pipefail
        BASE_REF="${{ github.event.before }}"
        python3 script/complexity_gate.py --base "$BASE_REF" --threshold 15

  tiered-regression:
    name: Tiered Regression (${{ matrix.tier }})
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        tier: [smoke, full]

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install System Dependencies
      run: |
        set -euo pipefail
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build libssl-dev ripgrep wget

    - name: Cache Boost 1.89
      id: cache-boost
      uses: actions/cache@v4
      with:
        key: boost-1.89.0-${{ runner.os }}-v1
        path: |
          ~/.cache/boost_1_89_0.tar.bz2
          ~/.cache/boost_1_89_0
          ~/.local/boost-1.89

    - name: Install Boost 1.89 from source
      if: steps.cache-boost.outputs.cache-hit != 'true'
      run: |
        set -euo pipefail
        mkdir -p "$HOME/.cache" "$HOME/.local"
        wget -O "$HOME/.cache/${BOOST_ARCHIVE}" "https://archives.boost.io/release/${BOOST_VERSION}/source/${BOOST_ARCHIVE}"
        rm -rf "$HOME/.cache/${BOOST_SRC_DIR}"
        tar xf "$HOME/.cache/${BOOST_ARCHIVE}" -C "$HOME/.cache"
        cd "$HOME/.cache/${BOOST_SRC_DIR}"
        ./bootstrap.sh --prefix="${BOOST_INSTALL_PREFIX}"
        ./b2 install -j15

    - name: Configure Tiered Build
      run: |
        cmake -S . -B build_tier -GNinja \
          -DCMAKE_BUILD_TYPE=Debug \
          -DENABLE_TSAN=OFF \
          -DENABLE_ASAN=ON \
          -DCMAKE_PREFIX_PATH="${BOOST_INSTALL_PREFIX}"

    - name: Build Tiered Tests
      run: cmake --build build_tier

    - name: Run Tiered Regression
      run: |
        set -euo pipefail
        bash script/run_test_tier.sh --tier "${{ matrix.tier }}" --build-dir build_tier --jobs 8

  tsan:
    name: TSAN (${{ matrix.suite }})
    runs-on: ubuntu-22.04

    strategy:
      fail-fast: false
      matrix:
        suite: [unit, integration]
    env:
      INTEGRATION_TEST_REGEX: integration|tproxy_integration|udp_integration|mux_connection_integration_test
      CI_ARTIFACT_DIR: ci_artifacts

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install System Dependencies
      run: |
        set -euo pipefail
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build libssl-dev python3 iproute2 iptables net-tools openssl curl gnupg ca-certificates ripgrep wget

    - name: Cache Boost 1.89
      id: cache-boost
      uses: actions/cache@v4
      with:
        key: boost-1.89.0-${{ runner.os }}-v1
        path: |
          ~/.cache/boost_1_89_0.tar.bz2
          ~/.cache/boost_1_89_0
          ~/.local/boost-1.89

    - name: Install Boost 1.89 from source
      if: steps.cache-boost.outputs.cache-hit != 'true'
      run: |
        set -euo pipefail
        mkdir -p "$HOME/.cache" "$HOME/.local"
        wget -O "$HOME/.cache/${BOOST_ARCHIVE}" "https://archives.boost.io/release/${BOOST_VERSION}/source/${BOOST_ARCHIVE}"
        rm -rf "$HOME/.cache/${BOOST_SRC_DIR}"
        tar xf "$HOME/.cache/${BOOST_ARCHIVE}" -C "$HOME/.cache"
        cd "$HOME/.cache/${BOOST_SRC_DIR}"
        ./bootstrap.sh --prefix="${BOOST_INSTALL_PREFIX}"
        ./b2 install -j15

    - name: Install Latest Clang
      run: |
        set -euo pipefail
        sudo rm -f /usr/share/keyrings/llvm-archive-keyring.gpg
        curl -fsSL https://apt.llvm.org/llvm-snapshot.gpg.key | sudo gpg --dearmor -o /usr/share/keyrings/llvm-archive-keyring.gpg
        echo "deb [signed-by=/usr/share/keyrings/llvm-archive-keyring.gpg] https://apt.llvm.org/jammy/ llvm-toolchain-jammy main" | sudo tee /etc/apt/sources.list.d/llvm.list >/dev/null
        sudo apt-get update
        sudo apt-get install -y clang lld
        clang --version
        clang++ --version

    - name: Prepare Artifact Directory
      run: mkdir -p "$CI_ARTIFACT_DIR"

    - name: Configure TSAN Build
      run: |
        cmake -S . -B build_tsan -GNinja \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_C_COMPILER=clang \
          -DCMAKE_CXX_COMPILER=clang++ \
          -DENABLE_TSAN=ON \
          -DENABLE_ASAN=OFF \
          -DCMAKE_PREFIX_PATH="${BOOST_INSTALL_PREFIX}"

    - name: Build TSAN
      run: cmake --build build_tsan

    - name: Run TSAN Unit Test Suite
      if: matrix.suite == 'unit'
      run: ctest --test-dir build_tsan --parallel --output-on-failure --output-log "$CI_ARTIFACT_DIR/ctest_tsan_unit.log" -E "$INTEGRATION_TEST_REGEX"

    - name: Run TSAN Integration Tests
      if: matrix.suite == 'integration'
      run: ctest --test-dir build_tsan --parallel --output-on-failure --output-log "$CI_ARTIFACT_DIR/ctest_tsan_integration.log" -R "$INTEGRATION_TEST_REGEX"

    - name: Upload TSAN Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: tsan-${{ matrix.suite }}-artifacts
        if-no-files-found: warn
        path: |
          ${{ env.CI_ARTIFACT_DIR }}/**

  valgrind:
    name: Valgrind Memory Safety
    runs-on: ubuntu-22.04

    env:
      CI_ARTIFACT_DIR: ci_artifacts

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install System Dependencies
      run: |
        set -euo pipefail
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build libssl-dev python3 valgrind openssl wget

    - name: Cache Boost 1.89
      id: cache-boost
      uses: actions/cache@v4
      with:
        key: boost-1.89.0-${{ runner.os }}-v1
        path: |
          ~/.cache/boost_1_89_0.tar.bz2
          ~/.cache/boost_1_89_0
          ~/.local/boost-1.89

    - name: Install Boost 1.89 from source
      if: steps.cache-boost.outputs.cache-hit != 'true'
      run: |
        set -euo pipefail
        mkdir -p "$HOME/.cache" "$HOME/.local"
        wget -O "$HOME/.cache/${BOOST_ARCHIVE}" "https://archives.boost.io/release/${BOOST_VERSION}/source/${BOOST_ARCHIVE}"
        rm -rf "$HOME/.cache/${BOOST_SRC_DIR}"
        tar xf "$HOME/.cache/${BOOST_ARCHIVE}" -C "$HOME/.cache"
        cd "$HOME/.cache/${BOOST_SRC_DIR}"
        ./bootstrap.sh --prefix="${BOOST_INSTALL_PREFIX}"
        ./b2 install -j15

    - name: Prepare Artifact Directory
      run: mkdir -p "$CI_ARTIFACT_DIR"

    - name: Configure Valgrind Build
      run: |
        cmake -S . -B build_valgrind -GNinja \
          -DCMAKE_BUILD_TYPE=Debug \
          -DENABLE_TSAN=OFF \
          -DENABLE_ASAN=OFF \
          -DCMAKE_PREFIX_PATH="${BOOST_INSTALL_PREFIX}"

    - name: Build Valgrind
      run: cmake --build build_valgrind

    - name: Validate Valgrind Script Args
      run: python3 script/valgrind_test.py --self-test-args

    - name: Run Valgrind Memory Safety Test
      run: |
        set -euo pipefail
        python3 script/valgrind_test.py --build-dir build_valgrind --socks-bin ./socks --server-ready-timeout 30 --client-ready-timeout 120 2>&1 | tee "$CI_ARTIFACT_DIR/valgrind.log"

    - name: Upload Valgrind Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: valgrind-artifacts
        if-no-files-found: warn
        path: |
          ${{ env.CI_ARTIFACT_DIR }}/**
          build_valgrind/*_valgrind.log
          build_valgrind/val_*stdout.log

  coverage:
    name: Coverage Gate
    runs-on: ubuntu-22.04

    env:
      CI_ARTIFACT_DIR: ci_artifacts

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install System Dependencies
      run: |
        set -euo pipefail
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build libssl-dev python3 python3-pip gcovr ripgrep wget

    - name: Cache Boost 1.89
      id: cache-boost
      uses: actions/cache@v4
      with:
        key: boost-1.89.0-${{ runner.os }}-v1
        path: |
          ~/.cache/boost_1_89_0.tar.bz2
          ~/.cache/boost_1_89_0
          ~/.local/boost-1.89

    - name: Install Boost 1.89 from source
      if: steps.cache-boost.outputs.cache-hit != 'true'
      run: |
        set -euo pipefail
        mkdir -p "$HOME/.cache" "$HOME/.local"
        wget -O "$HOME/.cache/${BOOST_ARCHIVE}" "https://archives.boost.io/release/${BOOST_VERSION}/source/${BOOST_ARCHIVE}"
        rm -rf "$HOME/.cache/${BOOST_SRC_DIR}"
        tar xf "$HOME/.cache/${BOOST_ARCHIVE}" -C "$HOME/.cache"
        cd "$HOME/.cache/${BOOST_SRC_DIR}"
        ./bootstrap.sh --prefix="${BOOST_INSTALL_PREFIX}"
        ./b2 install -j15

    - name: Prepare Artifact Directory
      run: mkdir -p "$CI_ARTIFACT_DIR"

    - name: Enforce Coverage >= 95% (line overall)
      run: |
        set -euo pipefail
        CMAKE_PREFIX_PATH="${BOOST_INSTALL_PREFIX}" BUILD_DIR=build_coverage COVERAGE_THRESHOLD=95 PER_FILE_GATE=0 BRANCH_PER_FILE_GATE=0 script/run_coverage.sh 2>&1 | tee "$CI_ARTIFACT_DIR/coverage.log"

    - name: Upload Coverage Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-artifacts
        if-no-files-found: warn
        path: |
          ${{ env.CI_ARTIFACT_DIR }}/**
          build_coverage/coverage_report/summary.json

  fuzzing-smoke:
    name: Fuzzing Smoke Test (Clang)
    runs-on: ubuntu-22.04
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install System Dependencies
      run: |
        set -euo pipefail
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build libssl-dev curl gnupg ca-certificates wget

    - name: Cache Boost 1.89
      id: cache-boost
      uses: actions/cache@v4
      with:
        key: boost-1.89.0-${{ runner.os }}-v1
        path: |
          ~/.cache/boost_1_89_0.tar.bz2
          ~/.cache/boost_1_89_0
          ~/.local/boost-1.89

    - name: Install Boost 1.89 from source
      if: steps.cache-boost.outputs.cache-hit != 'true'
      run: |
        set -euo pipefail
        mkdir -p "$HOME/.cache" "$HOME/.local"
        wget -O "$HOME/.cache/${BOOST_ARCHIVE}" "https://archives.boost.io/release/${BOOST_VERSION}/source/${BOOST_ARCHIVE}"
        rm -rf "$HOME/.cache/${BOOST_SRC_DIR}"
        tar xf "$HOME/.cache/${BOOST_ARCHIVE}" -C "$HOME/.cache"
        cd "$HOME/.cache/${BOOST_SRC_DIR}"
        ./bootstrap.sh --prefix="${BOOST_INSTALL_PREFIX}"
        ./b2 install -j15

    - name: Install Latest Clang
      run: |
        set -euo pipefail
        sudo rm -f /usr/share/keyrings/llvm-archive-keyring.gpg
        curl -fsSL https://apt.llvm.org/llvm-snapshot.gpg.key | sudo gpg --dearmor -o /usr/share/keyrings/llvm-archive-keyring.gpg
        echo "deb [signed-by=/usr/share/keyrings/llvm-archive-keyring.gpg] https://apt.llvm.org/jammy/ llvm-toolchain-jammy main" | sudo tee /etc/apt/sources.list.d/llvm.list >/dev/null
        sudo apt-get update
        sudo apt-get install -y clang lld
        clang --version
        clang++ --version

    - name: Configure CMake (Fuzzing)
      run: cmake -S . -B build_fuzz -DENABLE_FUZZING=ON -DCMAKE_CXX_COMPILER=clang++ -DCMAKE_C_COMPILER=clang -DCMAKE_PREFIX_PATH="${BOOST_INSTALL_PREFIX}" -GNinja

    - name: Build Fuzzers
      run: cmake --build build_fuzz

    - name: Smoke Test Fuzzers
      run: |
        ./build_fuzz/fuzz_socks_handshake -max_total_time=10
        ./build_fuzz/fuzz_reality_auth -max_total_time=10
        ./build_fuzz/fuzz_config -max_total_time=5
        ./build_fuzz/fuzz_reality_decrypt -max_total_time=10
        ./build_fuzz/fuzz_mux_codec -max_total_time=5
        ./build_fuzz/fuzz_ch_parser -max_total_time=5
