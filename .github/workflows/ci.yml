name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  quality-gates:
    name: Quality Gates
    runs-on: ubuntu-22.04
    
    steps:
    - uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build libssl-dev clang python3 python3-pip valgrind gcovr iproute2 iptables net-tools

    - name: Configure TSAN Build
      run: |
        cmake -S . -B build_tsan -GNinja \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_C_COMPILER=clang \
          -DCMAKE_CXX_COMPILER=clang++ \
          -DENABLE_TSAN=ON \
          -DENABLE_ASAN=OFF

    - name: Build TSAN
      run: cmake --build build_tsan -j15

    - name: Run TSAN Full Test Suite
      run: ctest --test-dir build_tsan -j20 --output-on-failure

    - name: Run TSAN Integration Tests
      run: ctest --test-dir build_tsan -j20 --output-on-failure -R 'integration|tproxy_integration|udp_integration|mux_connection_integration_test'

    - name: Configure Valgrind Build
      run: |
        cmake -S . -B build_valgrind -GNinja \
          -DCMAKE_BUILD_TYPE=Debug \
          -DENABLE_TSAN=OFF \
          -DENABLE_ASAN=OFF

    - name: Build Valgrind
      run: cmake --build build_valgrind -j15

    - name: Run Valgrind Memory Safety Test
      run: python3 script/valgrind_test.py --build-dir build_valgrind --socks-bin ./socks

    - name: Enforce Coverage >= 95% (per-file)
      run: BUILD_DIR=build_coverage BUILD_JOBS=15 TEST_JOBS=20 COVERAGE_THRESHOLD=95 PER_FILE_GATE=1 script/run_coverage.sh

  fuzzing-smoke:
    name: Fuzzing Smoke Test (Clang)
    runs-on: ubuntu-22.04
    
    steps:
    - uses: actions/checkout@v3

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build libssl-dev clang

    - name: Configure CMake (Fuzzing)
      run: cmake -S . -B build_fuzz -DENABLE_FUZZING=ON -DCMAKE_CXX_COMPILER=clang++ -DCMAKE_C_COMPILER=clang -GNinja

    - name: Build Fuzzers
      run: cmake --build build_fuzz

    - name: Smoke Test Fuzzers
      run: |
        ./build_fuzz/fuzz_socks_handshake -max_total_time=10
        ./build_fuzz/fuzz_reality_auth -max_total_time=10
        ./build_fuzz/fuzz_reality_decrypt -max_total_time=10
        ./build_fuzz/fuzz_mux_codec -max_total_time=5
        ./build_fuzz/fuzz_ch_parser -max_total_time=5
