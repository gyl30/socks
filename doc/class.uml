@startuml
!theme plain
hide empty members

package "Infrastructure" {
    class io_context_pool {
        + run()
        + get_io_context() : io_context&
        - work_guards_
    }

    class monitor_server {
        - acceptor_
        - token_
        - rate_state_
        + start()
        + stop()
    }
}

note right of io_context_pool
  每个异步对象绑定单一 io_context
  不引入 strand
end note

package "Mux Protocol Layer" {
    interface mux_stream_interface {
        + {abstract} on_data()
        + {abstract} on_close()
        + {abstract} on_reset()
    }

    class mux_connection {
        - socket_ : tcp::socket
        - streams_ : map<id, stream>
        - limits_config_
        + send_async(cmd, payload)
        + register_stream()
        + can_accept_stream()
        + has_stream()
        - read_loop()
        - write_loop()
    }

    class mux_dispatcher {
        + on_plaintext_data()
        + pack()
        - max_buffer_
    }

    class mux_tunnel_impl<StreamLayer> {
        - connection_ : shared_ptr<mux_connection>
        + create_stream() : shared_ptr<mux_stream>
    }

    class mux_stream {
        - id_ : uint32
        - recv_channel_
        + async_read_some()
        + async_write_some()
    }
}

package "Crypto Layer" {
    class reality_engine {
        - rx_buf_
        - tx_buf_
        + encrypt()
        + process_available_records()
    }
}

package "Client Side" {
    class client_tunnel_pool {
        - tunnel_pool_
        + start()
        + stop()
        + select_tunnel()
    }

    class socks_client {
        - acceptor_
        - tunnel_pool_ : shared_ptr<client_tunnel_pool>
        + accept_local_loop()
        + start()
        + stop()
    }

    class tproxy_client {
        - tcp_acceptor_
        - udp_socket_
        - tunnel_pool_ : shared_ptr<client_tunnel_pool>
        + accept_tcp_loop()
        + udp_loop()
        + udp_cleanup_loop()
    }

    class socks_session {
        - socket_ : tcp::socket
        + handshake_socks5()
        + run_tcp()
        + run_udp()
    }

    class tcp_socks_session {
        - idle_timer_
        + idle_watchdog()
    }

    class udp_socks_session {
        - idle_timer_
        + idle_watchdog()
    }

    class tproxy_tcp_session {
        - idle_timer_
        + idle_watchdog()
    }

    class tproxy_udp_session {
        - idle_timer_
        + idle_watchdog()
    }
}

package "Server Side" {
    class remote_server {
        - acceptor_
        - active_tunnels_
        - key_rotator_
        + accept_loop()
        + perform_handshake_response()
    }

    class remote_session {
        - target_socket_ : tcp::socket
        + start()
        + upstream()
        + downstream()
    }
    
    class remote_udp_session {
        - udp_socket_ : udp::socket
        + start()
        + idle_watchdog()
    }
}

' Relations
socks_client o-- io_context_pool
socks_client *-- client_tunnel_pool : uses >
socks_client ..> socks_session : creates >

tproxy_client o-- io_context_pool
tproxy_client *-- client_tunnel_pool : uses >
tproxy_client ..> tproxy_tcp_session : creates >
tproxy_client ..> tproxy_udp_session : creates >

client_tunnel_pool ..> mux_tunnel_impl : manages >
monitor_server o-- io_context_pool

socks_session ..> mux_stream : uses >
tcp_socks_session ..> upstream : uses >
udp_socks_session ..> mux_stream : uses >

remote_server o-- io_context_pool
remote_server ..> mux_tunnel_impl : creates >
remote_server ..> remote_session : spawns >

mux_tunnel_impl *-- mux_connection
mux_connection *-- reality_engine : owns >
mux_connection *-- mux_dispatcher : uses >
mux_connection o-- mux_stream_interface : manages >

mux_stream --|> mux_stream_interface
remote_session --|> mux_stream_interface
remote_udp_session --|> mux_stream_interface

mux_stream ..> mux_connection : weak_ptr backref >

@enduml
